---
title: "RMarkdown_Codigo"
author: "Luis Miguel Rioja Gallo"
date: "`r Sys.Date()`"
output: html_document
---


```{r message=FALSE, warning=FALSE}
library(readr)
library(dplyr)
library(tidyr)
library(readxl)
library(lubridate)
main_root<-'data'
carpetas<-c('2018','2019','2020','2021','2022')
subcarpeta1<-'Datos_diarios'
z_f<-list()
n=0
for (c in carpetas){
  files<-dir(paste(main_root,c,subcarpeta1,sep='/'))
  df_t<-list()
  names<-list()
  n=n+1
  i=1
  for (file in files){
    ds1 <- read_delim(paste(main_root,c,subcarpeta1,file,sep='/'), 
    delim = ";", escape_double = FALSE, trim_ws = TRUE)
    ds1<-ds1[ds1$PROVINCIA==3|ds1$PROVINCIA==12|ds1$PROVINCIA==46,]
    ds_1t <- pivot_longer(ds1, -(PROVINCIA:DIA),names_to = "HORA", values_to = 'Valor', names_prefix = 'H')
    ds_1t <- ds_1t[, -which(names(ds_1t) == "MAGNITUD")]
    ds_1t <- ds_1t[, -which(names(ds_1t) == "PUNTO_MUESTREO")]
    ds_1t<-mutate(ds_1t,Fecha=ymd(paste(ANNO,MES,DIA,sep='-')))
    ds_1t<-select(ds_1t,-c('ANNO','MES','DIA'))
    ds_1t <- ds_1t %>% 
    group_by(Fecha,MUNICIPIO,PROVINCIA,ESTACION) %>%
    summarise(Valor=max(Valor,na.rm=TRUE))
    new_name=strsplit(file,'_')[[1]][1]
    ds_1t[new_name]<-ds_1t$Valor
    ds_1t<-select(ds_1t,-c('Valor'))
    df_t[[i]]<-ds_1t
    names[[i]]<-new_name
    i=i+1
  }
  names(df_t)<-names
  valids_var<-c('NO2','NOx','O3','PM10','PM25','SO2')
  df_t<-df_t[valids_var]
  z<-merge(df_t[[1]],df_t[[2]],all=TRUE)
  for (i in 3:length(df_t)){
    z<-merge(z,df_t[[i]],all=TRUE)
    
  }
  
z_f[[n]]<-z

}

```

El ICA define 6 categorías de calidad del aire: buena, razonablemente buena, regular, desfavorable, muy desfavorable, y extremadamente desfavorable. A cada estación se le asigna la peor categoría en términos de calidad del aire de cualquiera de los contaminantes que se tienen en consideración para su estimación, . Los contaminantes que se consideran en el índice son: Partículas en suspensión (PM10), Partículas en suspensión (PM2,5), Ozono troposférico (O3), Dióxido de nitrógeno (NO2) y Dióxido de azufre (SO2)


Cada elemento de la lista es un dataframe, el elemento 1 es del 2018 y asi hasta 2022.


```{r}

# Para 2018
meta_df <- read_excel("./data/2018/Metadatos/metainformacion_2018_tcm30-501408.xlsx", sheet="Estaciones evaluación 2018")
meta_df<-meta_df[meta_df$N_RED=='CCAA Com. Valenciana',]
z<-z_f[[1]]
z_2018<-merge.data.frame(meta_df,z, by=c('PROVINCIA','MUNICIPIO','ESTACION'))
columnas<-c('N_PROVINCIA','N_MUNICIPIO','LATITUD_G','LONGITUD_G','TIPO_AREA',colnames(z))
z_2018<-z_2018 %>% select(all_of(columnas))
z_2018<-select(z_2018,-c('PROVINCIA','MUNICIPIO'))

# Para 2019
meta_df <- read_excel("./data/2019/Metadatos/metainformacion_2019_tcm30-513561.xlsx", sheet="Estaciones evaluación 2019")
meta_df<-meta_df[meta_df$N_RED=='CCAA Com. Valenciana',]
z<-z_f[[2]]
z_2019<-merge.data.frame(meta_df,z, by=c('PROVINCIA','MUNICIPIO','ESTACION'))
columnas<-c('N_PROVINCIA','N_MUNICIPIO','LATITUD_G','LONGITUD_G','TIPO_AREA',colnames(z))
z_2019<-z_2019 %>% select(all_of(columnas))
z_2019<-select(z_2019,-c('PROVINCIA','MUNICIPIO'))

# Para 2020
meta_df <- read_excel("./data/2020/Metadatos/metainformacionestacionesymagnitudes2020_tcm30-531266.xlsx", 
    sheet = "Estaciones")
meta_df<-meta_df[meta_df$N_RED=='CCAA Com. Valenciana',]
z<-z_f[[3]]
z_2020<-merge.data.frame(meta_df,z, by=c('PROVINCIA','MUNICIPIO','ESTACION'))
columnas<-c('N_PROVINCIA','N_MUNICIPIO','LATITUD_G','LONGITUD_G','TIPO_AREA',colnames(z))
z_2020<-z_2020 %>% select(all_of(columnas))
z_2020<-select(z_2020,-c('PROVINCIA','MUNICIPIO'))

# Para 2021
meta_df <- read_excel("./data/2021/Metadatos/metainformacion2021_tcm30-545563.xlsx", sheet="Estaciones")
meta_df<-meta_df[meta_df$N_RED=='CCAA Com. Valenciana',]
z<-z_f[[4]]
z_2021<-merge.data.frame(meta_df,z, by=c('PROVINCIA','MUNICIPIO','ESTACION'))
columnas<-c('N_PROVINCIA','N_MUNICIPIO','LATITUD_G','LONGITUD_G','TIPO_AREA',colnames(z))
z_2021<-z_2021 %>% select(all_of(columnas))
z_2021<-select(z_2021,-c('PROVINCIA','MUNICIPIO'))

# Para 2022
meta_df <- read_excel("./data/2022/Metadatos/Metainformacion2022.xlsx", sheet="Estaciones")
meta_df<-meta_df[meta_df$N_RED=='CCAA Com. Valenciana',]
z<-z_f[[5]]
z_2022<-merge.data.frame(meta_df,z, by=c('PROVINCIA','MUNICIPIO','ESTACION'))
columnas<-c('N_PROVINCIA','N_MUNICIPIO','LATITUD_G','LONGITUD_G','TIPO_AREA',colnames(z))
z_2022<-z_2022 %>% select(all_of(columnas))
z_2022<-select(z_2022,-c('PROVINCIA','MUNICIPIO'))
```
    

```{r}
z_final<-rbind(z_2018,z_2019,z_2020,z_2021,z_2022)
#write.csv(z_final, "data/join_datas.csv")

summary(z_final)
```



```{r}


#df<-z_final
#requiere sf
library(sf)
df<-mutate(df,TIPO_AREA=as.factor(TIPO_AREA))
df <- st_as_sf(df, coords = c('LONGITUD_G','LATITUD_G'), crs = 4326)
df<-st_transform(df,crs=32630)
X_UTM30N<-c()
Y_UTM30N<-c()
for (i in 1:nrow(df)){
  X_UTM30N<-c(X_UTM30N,st_bbox(df$geometry[i])[[1]])
  Y_UTM30N<-c(Y_UTM30N,st_bbox(df$geometry[i])[[2]])
}
df$X_UTM30N<-X_UTM30N
df$Y_UTM30N<-Y_UTM30N

```

# modelo lineal


```{r}
sample <- sample(c(TRUE, FALSE), nrow(df), replace=TRUE, prob=c(0.7,0.3))
train  <- df[sample, ]
test   <- df[!sample, ]

lm.NO2<-lm(NO2~NOx,train)
summary(lm.NO2)

predict<-predict.lm(lm.NO2,test)
RMSE<-sqrt(mean((test$NO2-predict) ^ 2, na.rm=T))
SD_NO2<-sd(df$NO2,na.rm=T)

hist(df$NO2)
summary(df$NO2)



```
 
 
    
```{r}
df_imputed1<-df
df_imputed1[is.na(df_imputed1$NO2),]$NO2<-predict.lm(lm.NO2,df_imputed1[is.na(df_imputed1$NO2),])
hist(df_imputed1$NO2)
summary(df_imputed1$NO2)
```


# Intento de imputación con kNN
```{r}
df <- read.csv("data/join_datas.csv")
```

```{r}
library(VIM)
df2 <- subset(df, select = -NOx )
```

```{r}
origen <- as.Date("2018-01-01")
df2$Fecha.num<- as.numeric(difftime(df2$Fecha, origen, units = "days"))

df3 <- kNN(df2, variable = c("SO2"), dist_var = c("X_UTM30N", "Y_UTM30N", "Fecha.num"), k = 1)
```

```{r}
df2 <- kNN(df3, variable = c("SO2"), dist_var = c("X_UTM30N", "Y_UTM30N", "Fecha"), k = 1)
```

```{r}
library(readr)
imputed_datas <- read_csv("data/imputed_datas.csv")

hist(imputed_datas$NO2.num)
```


```{r}
x <- imputed_datas$SO2.num
y <- character(length = length(x))

for (i in 1:length(x)) {
  if (x[i] >= 0 & x[i] <= 100) {
    y[i] <- "Buena"
  } else if (x[i] >= 101 & x[i] <= 200) {
    y[i] <- "Razonablemente Buena"
  } else if (x[i] >= 201 & x[i] <= 350) {
    y[i] <- "Regular"
  } else if (x[i] >= 351 & x[i] <= 500) {
    y[i] <- "Desfavorable"
  } else if (x[i] >= 501 & x[i] <= 750) {
    y[i] <- "Muy desfavorable"
  } else if (x[i] >= 751 & x[i] <= 1250) {
    y[i] <- "Extremadamente desfavorable"
  }
}

df$SO2.cat <- y
```


```{r}
df$SO2.cat <- factor(df$SO2.cat, ordered = TRUE, levels = c(
  "Buena", "Razonablemente Buena", "Regular", 
  "Desfavorable", "Muy desfavorable", "Extremadamente desfavorable"))
```


```{r}
path <-  "imputed_cat.csv"
write.csv(df, file =path, row.names = FALSE)

```

```{r}
df$NO2.cat <- as.factor(df$NO2.cat)
```

```{r}
library(readr)
df <- read_csv("imputed_cat.csv")
```
```{r}

df$SO3.cat <- factor(df$SO3.cat, levels = c(
  "Buena", "Razonablemente Buena", "Regular", 
  "Desfavorable", "Muy desfavorable", "Extremadamente desfavorable", ordered = T))

```

```{r}
j <- df

# Assuming your data frame is named 'df' and you have five factor columns: A, B, C, D, E
j$ICA <- apply(j[,c("NO2.cat", "O3.cat", "PM10.cat", "PM25.cat", "SO2.cat")], 1, function(row) max(row))


```

__________________________________________


# Primero vamos a realizar un `ggpairs` y un `ggcorr`para relacionar todos los elementos químicos con 
todos (valores numéricos)

```{r}

library(GGally)
num_cols <- c("NO2.num", "O3.num", "PM10.num", "PM25.num", "SO2.num")
ggpairs(df[num_cols])
```

 

```{r}
ggcorr(df[num_cols])
```
Como podemos ver, la relación de las variables no es clara. De forma general podemos decir que las variables
son bastante independientes entre sí.Como excepción podríamos hablar de las variables PM10 y PM25

```{r}
Cov_Mat <- cov(df[num_cols])

print("Matriz de covarianza")
print(Cov_Mat)

```


```{r}
Cor_Mat_S <- cor(df[num_cols], method = "spearman")
Cor_Mat_P <- cor(df[num_cols], method = "pearson")

print("Matriz de correlacion (Spearman)")
print(Cor_Mat_S)
print("Matriz de correlacion (Pearson)")
print(Cor_Mat_P)

```
Ya que hemos visto que las variables PM10 y PM25, vamos a relacionar sus variables categóricas pra ver la relación.


```{r}


chisq.test(df$PM10.cat, df$PM25.cat, correct = F)



```























































